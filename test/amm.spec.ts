import { AMMStateResponse, OrderBooksV3Response } from '../src/backend/secrettune/BorosBackendSDK';
import { combineMarketOrderBookAndAMM } from '../src/entities/amm/amm';

describe('combineMarketOrderBookAndAmm', () => {
  it('should combine correctly when AMMImpliedRate is between best bid and best ask rate', () => {
    const tickStep = 2;
    const tickSize = 0.001;
    const marketOrderBook: OrderBooksV3Response = {
      long: {
        ia: [95, 90, 85, 80, 75, 70, 65, 60, 55, 50],
        sz: [
          '76200000000000000000',
          '20000000000000000',
          '2000000000000000000',
          '10000000000000000',
          '3205182798196236520',
          '10000000000000000',
          '100000000000000000',
          '100000000000000000',
          '100000000000000000',
          '100000000000000000',
        ],
      },
      short: {
        ia: [105, 110, 115, 120, 125, 130, 135, 140, 145, 150],
        sz: [
          '99790000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
        ],
      },
    };

    const ammStateResponse: AMMStateResponse = {
      totalFloatAmount: '2490787079878783975900',
      normFixedAmount: '249078707987878397590',
      totalLp: '787656033893671113961',
      latestFTime: '1743811200',
      maturity: '1747872000',
      seedTime: '1743062400',
      minAbsRate: '10000000000000000',
      maxAbsRate: '300000000000000000',
      cutOffTimestamp: '1747872000',
    };

    const isPositiveAMM = true;
    const result = combineMarketOrderBookAndAMM(tickStep, tickSize, marketOrderBook, ammStateResponse, isPositiveAMM);

    expect(result).toEqual({
      long: {
        ia: [99, 98, 97, 96, 95, 94, 93, 92, 91, 90],
        sz: [
          '13469387449995588864',
          '15197063310689495087',
          '13890632559344360547',
          '14097889056309584524',
          '90510346274915562000',
          '14528188188937266811',
          '14751607206558286703',
          '14980804647123297951',
          '16921442190619585810',
          '15504602812753246400',
        ],
      },
      short: {
        ia: [101, 102, 103, 104, 105, 106, 107, 108, 109, 110],
        sz: [
          '13256149061401262872',
          '13068998040241425862',
          '12886207633981198949',
          '12707637313820576755',
          '112323152309234337147',
          '12362623322574915750',
          '12195926260227065178',
          '12032941979217477849',
          '11873556048263233334',
          '11738658522319630463',
        ],
      },
    });
  });

  it('should combine correctly when AMMImpliedRate is bigger than best ask rate', () => {
    const tickStep = 2;
    const tickSize = 0.001;
    const marketOrderBook: OrderBooksV3Response = {
      long: {
        ia: [45, 43, 37, 32, 10, 9, 0],
        sz: [
          '7620000000000000000',
          '20000000000000000',
          '2000000000000000000',
          '10000000000000000',
          '3205182798196236520',
          '10000000000000000',
          '100000000000000000',
        ],
      },
      short: {
        ia: [71, 101],
        sz: ['99790000000000000000', '21000000000000000'],
      },
    };

    const ammStateResponse: AMMStateResponse = {
      totalFloatAmount: '2490787079878783975900',
      normFixedAmount: '249078707987878397590',
      totalLp: '787656033893671113961',
      latestFTime: '1743811200',
      maturity: '1747872000',
      seedTime: '1743062400',
      minAbsRate: '10000000000000000',
      maxAbsRate: '300000000000000000',
      cutOffTimestamp: '1747872000',
    };

    const isPositiveAMM = true;
    const result = combineMarketOrderBookAndAMM(tickStep, tickSize, marketOrderBook, ammStateResponse, isPositiveAMM);

    expect(result).toEqual({
      long: {
        ia: [45, 44, 43, 42, 41, 40, 39, 38, 37, 36],
        sz: [
          '1357836823497773771912',
          '49242658065339397967',
          '45863254089799740980',
          '52731869341950595334',
          '54736252496614680688',
          '51083083582284077891',
          '58910928761147819185',
          '61324701415538667748',
          '59394730352154065625',
          '66388260859717645191',
        ],
      },
      short: {
        ia: [71, 101, 102, 103, 104, 105, 106, 107, 108, 109],
        sz: [
          '99790000000000000000',
          '13277149061401262872',
          '13068998040241425862',
          '12886207633981198949',
          '12707637313820576755',
          '12533152309234337147',
          '12362623322574915750',
          '12195926260227065178',
          '12032941979217477849',
          '11873556048263233334',
        ],
      },
    });
  });

  it('should combine correctly when AMMImpliedRate is smaller than best bid rate', () => {
    const tickStep = 2;
    const tickSize = 0.001;
    const marketOrderBook: OrderBooksV3Response = {
      long: {
        ia: [120, 115, 110, 105, 100, 95, 90, 85, 80, 75],
        sz: [
          '7620000000000000000',
          '20000000000000000',
          '2000000000000000000',
          '10000000000000000',
          '3205182798196236520',
          '10000000000000000',
          '100000000000000000',
          '100000000000000000',
          '100000000000000000',
          '100000000000000000',
        ],
      },
      short: {
        ia: [125, 130, 135, 140, 145, 150, 155, 160, 165, 170],
        sz: [
          '99790000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
          '21000000000000000',
        ],
      },
    };

    const ammStateResponse: AMMStateResponse = {
      totalFloatAmount: '2490787079878783975900',
      normFixedAmount: '249078707987878397590',
      totalLp: '787656033893671113961',
      latestFTime: '1743811200',
      maturity: '1747872000',
      seedTime: '1743062400',
      minAbsRate: '10000000000000000',
      maxAbsRate: '300000000000000000',
      cutOffTimestamp: '1747872000',
    };

    const isPositiveAMM = true;
    const result = combineMarketOrderBookAndAMM(tickStep, tickSize, marketOrderBook, ammStateResponse, isPositiveAMM);

    expect(result).toEqual({
      long: {
        ia: [120, 115, 110, 105, 100, 99, 98, 97, 96, 95],
        sz: [
          '7620000000000000000',
          '20000000000000000',
          '2000000000000000000',
          '10000000000000000',
          '3205182798196236520',
          '13469387449995588864',
          '15197063310689495087',
          '13890632559344360547',
          '14097889056309584524',
          '14320346274915562000',
        ],
      },
      short: {
        ia: [125, 126, 127, 128, 129, 130, 131, 132, 133, 134],
        sz: [
          '382486409921008001884',
          '9634847800606456112',
          '9524670706353569713',
          '9416581131980945241',
          '9310524254791670607',
          '9227447086024814586',
          '9104298396522904446',
          '8008475273661071900',
          '8916438585903682390',
          '8819588460258548052',
        ],
      },
    });
  });
});
